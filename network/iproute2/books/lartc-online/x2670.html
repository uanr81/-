<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
><TITLE
>Формирователь трафика: Низкая задержка, максимальная производительность.</TITLE
><META http-equiv="Content-Type" content="text/html; charset=koi8-r"><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.7"><LINK
REL="HOME"
TITLE="Linux Advanced Routing &#38; Traffic Control HOWTO"
HREF="index.html"><LINK
REL="UP"
TITLE="Решебник."
HREF="c2475.html"><LINK
REL="PREVIOUS"
TITLE="Решение проблемы с Path MTU Discovery путем настройки MSS."
HREF="x2657.html"><LINK
REL="NEXT"
TITLE="Ограничение скорости для отдельного хоста или подсети."
HREF="x2740.html"><style type="text/css"> p {text-align:justify;} </style></HEAD
><BODY
CLASS="SECTION"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Linux Advanced Routing &#38; Traffic Control HOWTO</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="x2657.html"
ACCESSKEY="P"
>Назад</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Глава 15. Решебник.</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="x2740.html"
ACCESSKEY="N"
>Вперед</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECTION"
><H1
CLASS="SECTION"
><A
NAME="THEULTIMATETRAFFICCONDITIONERLOWLATENCYFASTU"
></A
>15.8. Формирователь трафика: Низкая задержка, максимальная производительность.</H1
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
src="images/note.gif"
HSPACE="5"
ALT="Примечание:"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>      Этот сценарий претерпел существенные изменения. Ранее он предназначался только для Linux-клиентов 
      в вашей сети! Теперь же он может влиять на Windows и Mac машины
      </P
></TD
></TR
></TABLE
></DIV
><P
>      При разработке сценария преследовались следующие цели:
      <P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Обеспечить низкую задержку для интерактивного трафика.</DT
><DD
><P
>              Это означает, что перекачка больших объемов данных не должна отрицательно сказываться на
              работе через <B
CLASS="COMMAND"
>ssh</B
> или <B
CLASS="COMMAND"
>telnet</B
>. Это очень важно,
              поскольку в период интерактивного взаимодействия с удаленной системой даже незначительные
              задержки, скажем в 200 мсек, вызывают у пользователя чувство раздражения.
            </P
></DD
><DT
>Обеспечить приемлемую скорость web-серфинга</DT
><DD
><P
>              Даже учитывая тот факт, что http-трафик сам по себе является довольно объемным,
              он не должен подвергаться значительным задержкам.
            </P
></DD
><DT
>Обеспечить достаточно высокую скорость передачи больших объемов данных.</DT
><DD
><P
>              Довольно часто возникает ситуация, когда исходящий трафик практически полностью
              блокирует входящий.
            </P
></DD
></DL
></DIV
>
    </P
><P
>      Оказывается, что все поставленные цели вполне достижимы. Основная причина, по которой перекачка
      значительных объемов вызывает задержки интерактивного трафика, заключается в наличии больших очередей 
      во многих устройствах доступа, таких как модемы DSL.
    </P
><P
>      В следующем разделе дается детальное описание причин, которые вызывают задержки, и даются
      практические рекомендации по их устранению. Однако, если вас не интересуют пространные размышлизмы,
      то можете просто пропустить его и сразу перейти к разделам со сценариями. 
    </P
><DIV
CLASS="SECTION"
><H2
CLASS="SECTION"
><A
NAME="AEN2692"
></A
>15.8.1. Почему все так сложно?</H2
><P
>        Поставщикам услуг Интернет хорошо известно, что пользователей в основном интересует скорость,
        с которой они могут получать данные. Но помимо пропускной способности канала, на скорость скачивания очень
        сильно влияют факты потери пакетов. Увеличение очередей способствует уменьшению потерь, что в свою очередь
        приводит к увеличению скорости скачивания. Поэтому поставщики услуг, как правило, создают
        очереди очень большого объема.
      </P
><P
>        Однако, увеличение очередей приводит к появлению задержек в интерактивном трафике. 
        Интерактивные пакеты сначала попадают в исходящую очередь, где они ожидают отправки на удаленную систему,
        в результате может пройти до нескольких секунд (!), пока они достигнут места назначения. 
        То же самое повторяется на обратном пути -- сначала пакеты попадают в огромную очередь
        для входящего трафика, у поставщика услуг, долго ожидают отправки и только потом попадают
        к вам. 
      </P
><P
>        В этом руководстве мы расскажем вам, о способах обслуживания очередей, но, к большому сожалению,
        не все очереди нам доступны. Так, очереди поставщика услуг нам не подвластны совершенно, 
        в то время, как очередь исходящего трафика, скорее всего находится внутри вашего кабельного или 
        DSL модема. Некоторые модели допускают возможность конфигурирования очередей, но чаще всего такая 
        возможность отсутствует.
      </P
><P
>        Итак, что же дальше? Поскольку мы лишены возможности управлять этими очередями, то напрашивается 
        очевидное решение -- они должны быть перемещены на наш Linux-маршрутизатор. К счастью это возможно.
        Для этого необходимо:
      </P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Ограничить скорость исходящего трафика.</DT
><DD
><P
>              Ограничивая скорость исходящего трафика, величиной несколько меньшей, чем
              пропускная способность канала, мы тем самым ликвидируем исходящую очередь в модеме.
              Таким образом, исходящая очередь как бы перемещается в маршрутизатор.
            </P
></DD
><DT
>Ограничить скорость входящего трафика.</DT
><DD
><P
>              Это немного сложнее, поскольку действительно отсутствует возможность влияния на
              скорость поступления данных. Тем не менее, можно попробовать сбрасывать пакеты,
              если скорость поступления слишком высока, это заставит TCP/IP снизить скорость
              передачи до желаемого уровня. Поскольку в данном вопросе чрезмерное усердие может
              только навредить, то необходимо предусмотреть величину возможного превышения
              на коротких отрезках времени.
            </P
></DD
></DL
></DIV
><P
>        При выполнении этих условий, входящая очередь будет ликвидирована полностью (за исключением
        коротких пиков), и появляется возможность управления исходящей очередью, используя всю
        мощь, которую предоставляет операционная система Linux.
      </P
><P
>        После этого остается обеспечить первоочередную передачу интерактивного трафика. 
        А для того, чтобы входящий трафик не блокировался исходящим, необходимо так же обеспечить первоочередную
        передачу ACK-пакетов. При наличии объемного трафика в обоих направлениях, возникают значительные задержки,
        поэтому входящие ACK-пакеты не должны проигрывать в конкурентной борьбе с исходящим трафиком.
      </P
><P
>        После выполнения необходимых настроек, мы получили следующие результаты на ADSL соединении в Нидерландах:
        <PRE
CLASS="SCREEN"
>Базовое время ожидания отклика:
туда-обратно мин/ср/макс = 14.4/17.1/21.7 мсек

Во время скачивания, без формирователя трафика:
туда-обратно мин/ср/макс = 560.9/573.6/586.4 мсек

Во время отправки большого объема, без формирователя трафика:
туда-обратно мин/ср/макс = 2041.4/2332.1/2427.6 мсек

С формирователем трафика, при отправке большого файла на скорости 220 Кбит/сек:
round-trip min/avg/max = 15.7/51.8/79.9 мсек

С формирователем трафика, при скачивании на скорости 850 Кбит/сек:
туда-обратно мин/ср/макс = 20.4/46.9/74.0 мсек

При наличии исходящего трафика, скорость входящего достигает ~80% 
от максимально возможного значения. Скорость исходящего трафика
колеблется около 90%. При этом время ожидания подскакивает до 850 мсек, 
причина пока не выяснена.
        </PRE
>
      </P
><P
>        Чего можно ожидать от этого сценария, во многом зависит от фактической пропускной способности
        канала для исходящего потока. При наличии объемного исходящего трафика, перед исходящим интерактивным
        пакетом практически всегда будет стоять какой либо другой пакет, что и обусловливает
        нижний предел времени ожидания. Вы можете рассчитать этот предел, разделив MTU на максимальную
        скорость для исходящего потока. Типичные значения будут несколько выше. 
        Чтобы достичь лучшего эффекта, можно попробовать несколько уменьшить MTU!
      </P
><P
>        Ниже приводятся две версии сценария формирователя трафика. Одна версия построена на базе HTB,
        разработанной Девиком (Devik), другая -- на базе CBQ, которая, в отличие от HTB, включена в состав 
        ядра Linux. Оба сценария проверены и дают прекрасные результаты.
      </P
></DIV
><DIV
CLASS="SECTION"
><H2
CLASS="SECTION"
><A
NAME="AEN2713"
></A
>15.8.2. Формирователь трафика на базе CBQ.</H2
><P
>        Может работать практически с любой версией ядра. В данной реализации, внутри CBQ qdisc размещаются
        две SFQ (Stochastic Fairness Queues), что даст возможность равноправного сосуществования нескольких
        потоков данных.
      </P
><P
>        Входящий трафик формируется с помощью <B
CLASS="COMMAND"
>tc</B
>-фильтров, содержащих Token Bucket Filter.
      </P
><P
>        Вы можете улучшить сценарий за счет добавления ключевых слов <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>bounded</I
></SPAN
> в строках,
        начинающихся со слов <B
CLASS="COMMAND"
>tc class add .. classid 1:20</B
>. Если вы предполагаете
        уменьшать MTU, не забудьте уменьшить и значения <B
CLASS="COMMAND"
>allot</B
> и <B
CLASS="COMMAND"
>avpkt</B
>! 
        <PRE
CLASS="SCREEN"
>#!/bin/bash 

# Формирователь трафика для домашнего соединения с Интернет
# 
#
# Установите следующие параметры так, чтобы они были немного меньше фактических
# Единицы измерения -- килобиты
DOWNLINK=800
UPLINK=220
DEV=ppp0

# очистка входящей и исходящей qdisc
tc qdisc del dev $DEV root    2&#62; /dev/null &#62; /dev/null
tc qdisc del dev $DEV ingress 2&#62; /dev/null &#62; /dev/null

###### исходящий трафик

# установка корневой CBQ

tc qdisc add dev $DEV root handle 1: cbq avpkt 1000 bandwidth 10mbit 

# ограничить общую исходящую скорость величиной $UPLINK -- это предотвратит
# появление огромных очередей в DSL модеме,
# которые отрицательно сказываются на величине задержки:
# базовый класс

tc class add dev $DEV parent 1: classid 1:1 cbq rate ${UPLINK}kbit \
allot 1500 prio 5 bounded isolated 

# высокоприоритетный (интерактивный) класс 1:10:

tc class add dev $DEV parent 1:1 classid 1:10 cbq rate ${UPLINK}kbit \
   allot 1600 prio 1 avpkt 1000

# класс по-умолчанию 1:20 -- получает немного меньший объем трафика
# и имеет более низкий приоритет:

tc class add dev $DEV parent 1:1 classid 1:20 cbq rate $[9*$UPLINK/10]kbit \
   allot 1600 prio 2 avpkt 1000

# оба получают дисциплину Stochastic Fairness:
tc qdisc add dev $DEV parent 1:10 handle 10: sfq perturb 10
tc qdisc add dev $DEV parent 1:20 handle 20: sfq perturb 10

# определения фильтров
# TOS = Minimum-Delay (ssh, НО НЕ scp) -- в 1:10:
tc filter add dev $DEV parent 1:0 protocol ip prio 10 u32 \
      match ip tos 0x10 0xff  flowid 1:10

# ICMP (ip protocol 1) -- в интерактивный класс 1:10
# так мы сможем удивить своих друзей:
tc filter add dev $DEV parent 1:0 protocol ip prio 11 u32 \
	match ip protocol 1 0xff flowid 1:10

# Поднять скорость входящего трафика, при наличии исходящего -- передать ACK-пакеты
# в интерактивный класс:

tc filter add dev $DEV parent 1: protocol ip prio 12 u32 \
   match ip protocol 6 0xff \
   match u8 0x05 0x0f at 0 \
   match u16 0x0000 0xffc0 at 2 \
   match u8 0x10 0xff at 33 \
   flowid 1:10

# остальной трафик не является интерактивным поэтому передаем его в 1:20

tc filter add dev $DEV parent 1: protocol ip prio 13 u32 \
   match ip dst 0.0.0.0/0 flowid 1:20

########## входящий трафик #############
# необходимо несколько уменьшить скорость поступления входящего трафика,
# это предотвратит задержку пакетов в очередях у поставщика услуг.
# Поставщики имеют обыкновение увеличивать размеры очередей,
# поэтому, экспериментальным путем подберите требуемые значения,
# при которых скачивание будет происходить с максимальной скоростью.
#
# присоединить входной ограничитель:

tc qdisc add dev $DEV handle ffff: ingress

# сбрасывать все подряд (0.0.0.0/0), что приходит со слишком большой скоростью.

tc filter add dev $DEV parent ffff: protocol ip prio 50 u32 match ip src \
   0.0.0.0/0 police rate ${DOWNLINK}kbit burst 10k drop flowid :1        
        </PRE
>
      </P
><P
>        Если вы собираетесь использовать этот сценарий совместно с <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>ppp</I
></SPAN
> --
        скопируйте его в <TT
CLASS="FILENAME"
>/etc/ppp/ip-up.d</TT
>.
      </P
><P
>        Если последние две строки в сценарии порождают сообщения об ошибке -- обновите версию
        <B
CLASS="COMMAND"
>tc</B
>!
      </P
></DIV
><DIV
CLASS="SECTION"
><H2
CLASS="SECTION"
><A
NAME="AEN2729"
></A
>15.8.3. Формирователь трафика на базе HTB.</H2
><P
>        Следующий вариант сценария достигает поставленных целей за счет использования замечательных
        особенностей HTB (см. раздел <A
HREF="x1075.html#HIERARCHICALTOKENBUCKET"
>Hierarchical Token Bucket</A
>). 
        Требует наложения <SPAN
CLASS="QUOTE"
>"заплаты"</SPAN
> на ядро!
        <PRE
CLASS="SCREEN"
>#!/bin/bash

# Формирователь трафика для домашнего соединения с Интернет
# 
#
# Установите следующие параметры так, чтобы они были немного меньше фактических
# Единицы измерения -- килобиты
DOWNLINK=800
UPLINK=220
DEV=ppp0

# очистка входящей и исходящей qdisc
tc qdisc del dev $DEV root    2&#62; /dev/null &#62; /dev/null
tc qdisc del dev $DEV ingress 2&#62; /dev/null &#62; /dev/null

###### исходящий трафик

# установка корневой HTB, отправить трафик по-умолчанию в 1:20:

tc qdisc add dev $DEV root handle 1: htb default 20

# ограничить общую исходящую скорость величиной $UPLINK -- это предотвратит
# появление огромных очередей в DSL модеме,
# которые отрицательно сказываются на величине задержки:

tc class add dev $DEV parent 1: classid 1:1 htb rate ${UPLINK}kbit burst 6k

# высокоприоритетный (интерактивный) класс 1:10:

tc class add dev $DEV parent 1:1 classid 1:10 htb rate ${UPLINK}kbit \
   burst 6k prio 1

# класс по-умолчанию 1:20 -- получает немного меньший объем трафика
# и имеет более низкий приоритет:

tc class add dev $DEV parent 1:1 classid 1:20 htb rate $[9*$UPLINK/10]kbit \
   burst 6k prio 2

# оба получают дисциплину Stochastic Fairness:
tc qdisc add dev $DEV parent 1:10 handle 10: sfq perturb 10
tc qdisc add dev $DEV parent 1:20 handle 20: sfq perturb 10

# TOS = Minimum-Delay (ssh, НО НЕ scp) -- в 1:10:
tc filter add dev $DEV parent 1:0 protocol ip prio 10 u32 \
      match ip tos 0x10 0xff  flowid 1:10

# ICMP (ip protocol 1) -- в интерактивный класс 1:10
# так мы сможем удивить своих друзей:
tc filter add dev $DEV parent 1:0 protocol ip prio 10 u32 \
	match ip protocol 1 0xff flowid 1:10

# Поднять скорость входящего трафика, при наличии исходящего -- передать ACK-пакеты
# в интерактивный класс:

tc filter add dev $DEV parent 1: protocol ip prio 10 u32 \
   match ip protocol 6 0xff \
   match u8 0x05 0x0f at 0 \
   match u16 0x0000 0xffc0 at 2 \
   match u8 0x10 0xff at 33 \
   flowid 1:10

# остальной трафик не является интерактивным поэтому он попадает в 1:20


########## входящий трафик #############
# необходимо несколько уменьшить скорость поступления входящего трафика,
# это предотвратит задержку пакетов в очередях у поставщика услуг.
# Поставщики имеют обыкновение увеличивать размеры очередей,
# поэтому, экспериментальным путем подберите требуемые значения,
# при которых скачивание будет происходить с максимальной скоростью.
#
# присоединить входной ограничитель:

tc qdisc add dev $DEV handle ffff: ingress

# сбрасывать все подряд (0.0.0.0/0), что приходит со слишком большой скоростью.

tc filter add dev $DEV parent ffff: protocol ip prio 50 u32 match ip src \
   0.0.0.0/0 police rate ${DOWNLINK}kbit burst 10k drop flowid :1        
        </PRE
>
      </P
><P
>        Если вы собираетесь использовать этот сценарий совместно с <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>ppp</I
></SPAN
> --
        скопируйте его в <TT
CLASS="FILENAME"
>/etc/ppp/ip-up.d</TT
>.
      </P
><P
>        Если последние две строки в сценарии порождают сообщения об ошибке -- обновите версию
        <B
CLASS="COMMAND"
>tc</B
>!
      </P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="x2657.html"
ACCESSKEY="P"
>Назад</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>В начало документа</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="x2740.html"
ACCESSKEY="N"
>Вперед</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Решение проблемы с Path MTU Discovery путем настройки MSS.</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="c2475.html"
ACCESSKEY="U"
>К началу раздела</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Ограничение скорости для отдельного хоста или подсети.</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
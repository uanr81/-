<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
><TITLE
>IPSEC: безопасная передача данных протоколами IP через Интернет</TITLE
><META http-equiv="Content-Type" content="text/html; charset=koi8-r"><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.7"><LINK
REL="HOME"
TITLE="Linux Advanced Routing &#38; Traffic Control HOWTO"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Тоннелирование IPv6 при помощьи Cisco и/или 6bone."
HREF="c455.html"><LINK
REL="NEXT"
TITLE="Пример автоматического конфигурирования безопасного соединения между двумя хостами."
HREF="x616.html"><style type="text/css"> p {text-align:justify;} </style></HEAD
><BODY
CLASS="CHAPTER"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Linux Advanced Routing &#38; Traffic Control HOWTO</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="c455.html"
ACCESSKEY="P"
>Назад</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="x616.html"
ACCESSKEY="N"
>Вперед</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="CHAPTER"
><H1
><A
NAME="CHAPTER7"
></A
>Глава 7. IPSEC: безопасная передача данных протоколами IP через Интернет</H1
><P
>    На сегодняшний день существует две реализации IPSEC в Linux. Для ядер 2.2 и 2.4  -- это пакет
    <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>FreeS/WAN</I
></SPAN
>, который является первой основной реализацией IPSEC. Этот проект
    имеет два сайта: официальный -- 
    <A
HREF="http://www.freeswan.org/"
TARGET="_top"
>http://www.freeswan.org/</A
> и неофициальный --
    <A
HREF="http://www.freeswan.ca/"
TARGET="_top"
>http://www.freeswan.ca/</A
>.
    <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>FreeS/WAN</I
></SPAN
> не вошел в состав ядра по ряду причин. Наиболее часто упоминается
    причина <SPAN
CLASS="QUOTE"
>"политического"</SPAN
> характера, связанная с Американскими законодательством, 
    запрещающим экспорт технологий шифрования. Кроме того, этот пакет довольно трудно интегрируется в 
    ядро Linux, что еще больше осложняет их слияние.
  </P
><P
>    В добавок ко всему, <A
HREF="http://www.edlug.ed.ac.uk/archive/Sep2002/msg00244.html"
TARGET="_top"
>многие
    </A
> высказывают  <A
HREF="http://lists.freeswan.org/pipermail/design/2002-November/003901.html"
TARGET="_top"
>    обеспокоенность</A
> качеством кода. В Интернет <A
HREF="http://www.freeswan.org/doc.html"
TARGET="_top"
>существует</A
>
    достаточное количество <A
HREF="http://www.freeswan.ca/docs/freeswan-1.99/doc/index.html"
TARGET="_top"
>    документации</A
>, описывающей процесс установки <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>FreeS/WAN</I
></SPAN
>.
  </P
><P
>    Начиная с версии 2.5.47, в ядре Linux появилась встроенная поддержка IPSEC. Реализация ее была
    выполнена Алексеем Кузнецовым и Дэйвом Миллером (Dave Miller), на основе разработок USAGI IPv6 group.
    С этой версии, CryptoAPI Джеймса Морриса (James Morris), так же стал частью ядра -- его средствами
    выполняется собственно шифрование.
  </P
><P
>    Этот документ будет описывать только IPSEC версии 2.5 (и выше). <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>FreeS/WAN</I
></SPAN
>
    рекомендуется для пользователей Linux 2.4, но вам следует знать, что его конфигурирование 
    сильно отличается от <SPAN
CLASS="QUOTE"
>"родного"</SPAN
> IPSEC. И наверное следует упомянуть о существовании
    <A
HREF="http://gondor.apana.org.au/%7Eherbert/freeswan/"
TARGET="_top"
><SPAN
CLASS="QUOTE"
>"заплаты"</SPAN
></A
>, 
    которая делает возможной работу пользовательских утилит <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>FreeS/WAN</I
></SPAN
>
    с <SPAN
CLASS="QUOTE"
>"родным"</SPAN
> для Linux IPSEC.
  </P
><P
>    Начиная с версии ядра Linux 2.5.49, для работы IPSEC уже не требуется наложения заплат.
  </P
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
src="images/note.gif"
HSPACE="5"
ALT="Примечание:"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>      Пользовательские утилиты, для работы с IPSEC, вы найдете по адресу:
      <A
HREF="http://sourceforge.net/projects/ipsec-tools"
TARGET="_top"
>      http://sourceforge.net/projects/ipsec-tools</A
>. В этот пакет, кроме всего прочего,
      входит ряд программ, основанных на Racoon.
    </P
><P
>      При пересборке ядра обязательно включите опции <B
CLASS="COMMAND"
>PF_KEY</B
>,
      <B
CLASS="COMMAND"
>AH</B
>, <B
CLASS="COMMAND"
>ESP</B
> и все опции в <B
CLASS="COMMAND"
>CryptoAPI</B
>!
    </P
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="WARNING"
><P
></P
><TABLE
CLASS="WARNING"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
src="images/warning.gif"
HSPACE="5"
ALT="Внимание!"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>      Автор этой главы полный кретин (впрочем у меня есть причины сомневаться в этом -- <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>      прим. перев.</I
></SPAN
>)  в области IPSEC! Если в этой главе вы столкнетесь с неизбежными ошибками,
      пожалуйста, сообщите о них Берту Хьюберту (Bert Hubert), по адресу:
      <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:ahu@ds9a.nl"
>ahu@ds9a.nl</A
>&#62;</TT
>.
    </P
></TD
></TR
></TABLE
></DIV
><P
>    Для начала мы рассмотрим -- как вручную настроить безопасное соединение между двумя хостами. Большая
    часть этого процесса может быть автоматизирована, но мы будем все делать вручную, чтобы показать
    всю его подноготную.
  </P
><P
>    Если вас интересует только автоматическое формирование ключей, то можете смело пропустить следующий
    раздел. Однако мы находим полезным знать принципы <SPAN
CLASS="QUOTE"
>"ручного"</SPAN
> подхода.
  </P
><DIV
CLASS="SECTION"
><H1
CLASS="SECTION"
><A
NAME="INTROWITHMANUALKEYING"
></A
>7.1. Пример ручного конфигурирования безопасного соединения между двумя хостами.</H1
><P
>       IPSEC -- довольно сложная тема. В Интернет вы найдете множество разнообразной информации по ней. 
       Этот документ концентрируется на проблемах настройки, запуска и объяснении основных принципов
       функционирования. Все примеры базируются на Racoon, который уже упоминался выше. 
    </P
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
src="images/note.gif"
HSPACE="5"
ALT="Примечание:"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>        Наиболее распространенные примеры настройки <B
CLASS="COMMAND"
>iptables</B
> не позволяют
        прохождение пакетов IPSEC! Чтобы сделать это возможным, вам следует добавить
        следующие правила:
        <B
CLASS="COMMAND"
>iptables -A xxx -p 50 -j ACCEPT</B
> и 
        <B
CLASS="COMMAND"
>iptables -A xxx -p 51 -j ACCEPT</B
>.
      </P
></TD
></TR
></TABLE
></DIV
><P
>      IPSEC представляет собой безопасную версию протокола IP. Понятие <SPAN
CLASS="QUOTE"
>"безопасность"</SPAN
>,
      в данном случае, означает возможность шифрования и аутентификации. В чистом виде, с технической точки 
      зрения, <SPAN
CLASS="QUOTE"
>"безопасность"</SPAN
> означает только шифрование, однако, довольно легко показать, что 
      этого недостаточно -- вы можете обмениваться шифрованными данными, но не иметь при этом гарантий,
      что удаленная сторона именно та, которую вы ожидаете. 
    </P
><P
>       Шифрование, в IPSEC, выполняется протоколом ESP (Encapsulating Security Payload --
       Инкапсулированные Защищенные Данные), аутентификация -- протоколом AH (Authentication Header -- Заголовок 
       Аутентификации). Вы можете сконфигурировать их оба, или один из них.
    </P
><P
>       И ESP, и AH опираются на Security Association (защищенный виртуальный канал, или контекст безопасности). 
       Security Association (SA) -- однонаправленное логическое соединение (от отправителя к получателю)  между 
       двумя системами, поддерживающими протокол IPSec, которое однозначно идентифицируется следующими тремя 
       параметрами:
      <P
></P
><UL
><LI
><P
>            индексом защищенного соединения (Security Parameter Index, SPI -- 32-битная константа, используемая 
            для идентификации различных SA c одинаковыми IP-адресом получателя и протоколом безопасности);
          </P
></LI
><LI
><P
>            IP-адресом получателя IP-пакетов (IP Destination Address);
          </P
></LI
><LI
><P
>            протоколом безопасности (Security Protocol -- AH или ESP).
          </P
></LI
></UL
>
       Пример создания защищенного канала (SA) для протокола AH  может выглядеть следующим образом: 
      <PRE
CLASS="SCREEN"
>add 10.0.0.11 10.0.0.216 ah 15700 -A hmac-md5 "1234567890123456";</PRE
>
    </P
><P
>      Эта строка говорит нам, что: <SPAN
CLASS="QUOTE"
>"Создается защищенный канал от узла сети с адресом
      10.0.0.11, к узлу сети с адресом 10.0.0.216. Что это данные
      аутентификации, которая выполняется протоколом AH, с использованием алгоритма
      шифрования hmac-md5 и ключом 1234567890123456."</SPAN
>. Эта инструкция помечена
      индексом SPI -- 15700.
      Здесь есть один интересный момент -- каждый защищенный виртуальный канал используется
      для передачи данных только в одном направлении (в данном примере: от 10.0.0.11 к 10.0.0.216).
      В случае необходимости двустороннего обмена создаются два виртуальных канала. Более того,
      для каждого из протоколов создаются свои виртуальные защищенные каналы передачи данных. Таким образом,
      если предполагается двусторонний обмен, с использованием обеих протоколов -- и AH, и ESP,
      то создаются 4 защищенных канала, по одному на каждое направление для каждого из протоколов.
    </P
><P
>      Пример создания защищенного канала (SA) для протокола ESP:
      <PRE
CLASS="SCREEN"
>add 10.0.0.11 10.0.0.216 esp 15701 -E 3des-cbc "123456789012123456789012";</PRE
>
    </P
><P
>      Этот пример говорит: <SPAN
CLASS="QUOTE"
>"Создается защищенный канал от 10.0.0.11 к 10.0.0.216, 
      в котором данные должны шифроваться алгоритмом
      3des-cbc с ключом 123456789012123456789012"</SPAN
>. Индекс SPI -- '15701'. 
    </P
><P
>      Фактически, может существовать любое число практически идентичных SA, но при этом, все они отличаются 
      различными индексами SPI. Пока что мы видели только то, как описываются виртуальные каналы безопасности 
      (SA), но до сих пор не встретили ни одного описания политик безопасности (правил обработки получаемых 
      пакетов). Для того, чтобы назначить эти правила, необходимо 
      описать политику безопасности. Она может включать в себя такие действия, как: <SPAN
CLASS="QUOTE"
>"обрабатывать пакет с 
      помощью IPSEC, если это возможно"</SPAN
> или <SPAN
CLASS="QUOTE"
>"сбросить пакет"</SPAN
>. 
    </P
><P
>      Типичный пример назначения политики безопасности:
      <PRE
CLASS="SCREEN"
>spdadd 10.0.0.216 10.0.0.11 any -P out ipsec
   esp/transport//require
   ah/transport//require;
      </PRE
>
        Применительно к хосту 10.0.0.216, это означает, что весь трафик, отправляемый хосту 10.0.0.11 должен 
        быть зашифрован и <SPAN
CLASS="QUOTE"
>"обернут"</SPAN
> протоколом AH, подтверждающим подлинность. Обратите внимание, 
        этот пример не описывает, какой из имеющихся каналов (SA) должен использоваться, это означает, что право
        выбора оставляется за ядром.
    </P
><P
>      Другими словами, Политика Безопасности описывает ЧТО следует предпринять в том
      или ином случае, а защищенный канал (SA) -- КАК получить данные.
    </P
><P
>      Исходящие пакеты <SPAN
CLASS="QUOTE"
>"подписываются"</SPAN
> соответствующим SPI (КАК). Ядро использует
      его для нужд шифрования и аутентификации так, чтобы удаленный хост мог выполнить необходимые
      проверки и дешифрацию.
    </P
><P
>      Ниже следует пример простой конфигурации, обеспечивающей передачу данных от 10.0.0.216 к 10.0.0.11
      с аутентификацией, в зашифрованном виде. Обратите внимание на то, что в обратном направлении
      данные передаются в открытом виде. Это лишь первая версия примера и она не должна рассматриваться
      вами как пригодная к употреблению.
    </P
><P
>      Для хоста 10.0.0.216:
    </P
><PRE
CLASS="PROGRAMLISTING"
>  
#!/sbin/setkey -f
add 10.0.0.216 10.0.0.11 ah 24500 -A hmac-md5 "1234567890123456";          
add 10.0.0.216 10.0.0.11 esp 24501 -E 3des-cbc "123456789012123456789012";

spdadd 10.0.0.216 10.0.0.11 any -P out ipsec
   esp/transport//require
   ah/transport//require;
    </PRE
><P
>      Для хоста 10.0.0.11, те же самые SA, но без политики безопасности:
    </P
><PRE
CLASS="PROGRAMLISTING"
>  
#!/sbin/setkey -f
add 10.0.0.216 10.0.0.11 ah 24500 -A hmac-md5 "1234567890123456";
add 10.0.0.216 10.0.0.11 esp 24501 -E 3des-cbc "123456789012123456789012";    
    </PRE
><P
>      В этой конфигурации попробуем дать команду <B
CLASS="COMMAND"
>ping 10.0.0.11</B
> с хоста
      10.0.0.216. В результате получим такой вывод от <B
CLASS="COMMAND"
>tcpdump</B
>:
      <PRE
CLASS="SCREEN"
>22:37:52 10.0.0.216 &#62; 10.0.0.11: AH(spi=0x00005fb4,seq=0xa): ESP(spi=0x00005fb5,seq=0xa) (DF)
22:37:52 10.0.0.11 &#62; 10.0.0.216: icmp: echo reply      
      </PRE
>
    </P
><P
>      Обратите внимание на то, как возвращается ответ на запрос -- он передается в открытом виде.
      В то время как сам запрос не распознается утилитой <B
CLASS="COMMAND"
>tcpdump</B
>,
      но зато она показывает SPI для AH и ESP, которые инструктируют хост 10.0.0.11, КАК выполнить
      проверку подлинности и дешифровать данные.
    </P
><P
>      Следует сделать несколько замечаний по поводу этих примеров. Такая конфигурация не обеспечивает
      достаточный уровень безопасности. Проблема состоит в том, что политика безопасности описывает
      только -- ЧТО должен сделать хост 10.0.0.216 при передаче данных хосту 10.0.0.11 и КАК их передать,
      а для хоста 10.0.0.11 описывается КАК он может получить эти данные, но нет правил, описывающих
      ЧТО он должен предпринять при получении нешифрованных пакетов, идущих от 10.0.0.216!
    </P
><P
>      Таким образом, если злоумышленник будет в состоянии выполнить <SPAN
CLASS="QUOTE"
>"подмену"</SPAN
>
      (spoofing) IP-адреса, то он сможет отправлять незашифрованные данные хосту 10.0.0.11,
      который примет их! Для устранения этой проблемы нужно прописать политику безопасности
      для хоста 10.0.0.11:
    </P
><PRE
CLASS="PROGRAMLISTING"
>  
#!/sbin/setkey -f 
spdadd 10.0.0.216 10.0.0.11 any -P IN ipsec
   esp/transport//require
   ah/transport//require;    
    </PRE
><P
>      Это описание сообщает хосту 10.0.0.11, что весь входящий трафик от хоста 10.0.0.216
      должен иметь подтверждение подлинности (AH) и должен быть зашифрован (ESP).
    </P
><P
>      Ниже приводится полная конфигурация сетевых узлов 10.0.0.11 и 10.0.0.216, для двустороннего обмена данными.
      Полная конфигурация для хоста 10.0.0.216: 
    </P
><PRE
CLASS="PROGRAMLISTING"
>  
#!/sbin/setkey -f
flush;
spdflush;

# AH
add 10.0.0.11 10.0.0.216 ah 15700 -A hmac-md5 "1234567890123456";
add 10.0.0.216 10.0.0.11 ah 24500 -A hmac-md5 "1234567890123456";

# ESP
add 10.0.0.11 10.0.0.216 esp 15701 -E 3des-cbc "123456789012123456789012";
add 10.0.0.216 10.0.0.11 esp 24501 -E 3des-cbc "123456789012123456789012";

spdadd 10.0.0.216 10.0.0.11 any -P out ipsec
           esp/transport//require
           ah/transport//require;

spdadd 10.0.0.11 10.0.0.216 any -P in ipsec
           esp/transport//require
           ah/transport//require;    
    </PRE
><P
>      И для 10.0.0.11:
    </P
><PRE
CLASS="PROGRAMLISTING"
>  
 #!/sbin/setkey -f
flush;
spdflush;

# AH
add 10.0.0.11 10.0.0.216 ah 15700 -A hmac-md5 "1234567890123456";
add 10.0.0.216 10.0.0.11 ah 24500 -A hmac-md5 "1234567890123456";

# ESP
add 10.0.0.11 10.0.0.216 esp 15701 -E 3des-cbc "123456789012123456789012";
add 10.0.0.216 10.0.0.11 esp 24501 -E 3des-cbc "123456789012123456789012";


spdadd 10.0.0.11 10.0.0.216 any -P out ipsec
           esp/transport//require
           ah/transport//require;

spdadd 10.0.0.216 10.0.0.11 any -P in ipsec
           esp/transport//require
           ah/transport//require;   
    </PRE
><P
>      Обратите внимание -- в этом примере использованы идентичные ключи шифрования для обоих 
      направлений. Однако, это не является обязательным требованием.
    </P
><P
>      Чтобы проверить только что созданную конфигурацию, достаточно дать команду <B
CLASS="COMMAND"
>setkey -D</B
>, 
      которая выведет перечень контекстов защиты (виртуальных защищенных каналов) или 
      <B
CLASS="COMMAND"
>setkey -DP </B
>, которая отобразит сконфигурированные политики безопасности. 
    </P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="c455.html"
ACCESSKEY="P"
>Назад</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>В начало документа</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="x616.html"
ACCESSKEY="N"
>Вперед</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Тоннелирование IPv6 при помощьи Cisco и/или 6bone.</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Пример автоматического конфигурирования безопасного соединения между двумя хостами.</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>